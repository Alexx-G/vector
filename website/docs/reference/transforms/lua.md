---
last_modified_on: "2020-04-02"
component_title: "Lua"
description: "The Vector `lua` transform accepts and outputs `log` and `metric` events allowing you to transform events with a full embedded Lua engine."
event_types: ["log","metric"]
function_category: "program"
issues_url: https://github.com/timberio/vector/issues?q=is%3Aopen+is%3Aissue+label%3A%22transform%3A+lua%22
sidebar_label: "lua|[\"log\",\"metric\"]"
source_url: https://github.com/timberio/vector/tree/master/src/transforms/lua
status: "beta"
title: "Lua Transform"
---

import Fields from '@site/src/components/Fields';
import Field from '@site/src/components/Field';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

The Vector `lua` transform
accepts and outputs [`log`][docs.data-model.log] and
[`metric`][docs.data-model.metric] events allowing you to transform events with
a full embedded [Lua][urls.lua] engine.

<!--
     THIS FILE IS AUTOGENERATED!

     To make changes please edit the template located at:

     website/docs/reference/transforms/lua.md.erb
-->

## Configuration

<Tabs
  block={true}
  defaultValue="v2"
  values={[{"label":"v2","value":"v2"},{"label":"v1","value":"v1"},{"label":"v2 (adv)","value":"v2-adv"},{"label":"v1 (adv)","value":"v1-adv"}]}>

<TabItem value="v2">

```toml title="vector.toml"
[transforms.my_transform_id]
  # General
  type = "lua" # required
  inputs = ["my-source-id"] # required
  version = "2" # required

  # Hooks
  hooks.process = """
  function (event, emit)
    event.log.field = "value" -- set value of a field
    event.log.another_field = nil -- remove field
    event.log.first, event.log.second = nil, event.log.first -- rename field
    emit(event) -- emit the processed event
  end
  """ # required
```

</TabItem>
<TabItem value="v1">

```toml title="vector.toml"
[transforms.my_transform_id]
  type = "lua" # required
  inputs = ["my-source-id"] # required
  source = """
  require("script") # a `script.lua` file must be in your [`search_dirs`](#search_dirs)

  if event["host"] == nil then
    local f = io.popen ("/bin/hostname")
    local hostname = f:read("*a") or ""
    f:close()
    hostname = string.gsub(hostname, "\n$", "")
    event["host"] = hostname
  end
  """ # required
```

</TabItem>
<TabItem value="v2-adv">

```toml title="vector.toml"
[transforms.my_transform_id]
  # General
  type = "lua" # required
  inputs = ["my-source-id"] # required
  version = "2" # required
  search_dirs = ["/etc/vector/lua"] # optional, no default

  # Timers
  timers.handler = """
  function (emit)
    emit {
      log = {
        message = "current time: " .. os.date()
      }
    }
  end

  """ # required
  timers.interval_seconds = 1 # required

  # Hooks
  hooks.process = """
  function (event, emit)
    event.log.field = "value" -- set value of a field
    event.log.another_field = nil -- remove field
    event.log.first, event.log.second = nil, event.log.first -- rename field
    emit(event) -- emit the processed event
  end
  """ # required
  hooks.init = """
  function (emit)
    local f = io.popen ("/bin/hostname") -- run "hostname" command to determine the hostname
    hostname = f:read("*a") or "" -- set a global variable which can be used in other hooks
    f:close() -- close the pipe

    emit {
      log = {
        message = "initialized!"
      }
    }
  end
  """ # optional, no default
  hooks.shutdown = """
  function (emit)
    emit {
      log = {
        message = "shutting down..."
      }
    }
  end
  """ # optional, no default
```

</TabItem>
<TabItem value="v1-adv">

```toml title="vector.toml"
[transforms.my_transform_id]
  type = "lua" # required
  inputs = ["my-source-id"] # required
  source = """
  require("script") # a `script.lua` file must be in your [`search_dirs`](#search_dirs)

  if event["host"] == nil then
    local f = io.popen ("/bin/hostname")
    local hostname = f:read("*a") or ""
    f:close()
    hostname = string.gsub(hostname, "\n$", "")
    event["host"] = hostname
  end
  """ # required
  search_dirs = ["/etc/vector/lua"] # optional, no default
```

</TabItem>
</Tabs>

<Fields filters={true}>
<Field
  common={true}
  defaultValue={null}
  enumValues={null}
  examples={[]}
  groups={["v2"]}
  name={"hooks"}
  path={null}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"table"}
  unit={null}
  >

### hooks

Configures hooks handlers.



<Fields filters={false}>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={["function (emit)\n  local f = io.popen (\"/bin/hostname\") -- run \"hostname\" command to determine the hostname\n  hostname = f:read(\"*a\") or \"\" -- set a global variable which can be used in other hooks\n  f:close() -- close the pipe\n\n  emit {\n    log = {\n      message = \"initialized!\"\n    }\n  }\nend"]}
  groups={["v2"]}
  name={"init"}
  path={"hooks"}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"string"}
  unit={null}
  >

#### init

A function which is called when the first event comes, before calling
`hooks.process`




</Field>
<Field
  common={true}
  defaultValue={null}
  enumValues={null}
  examples={["function (event, emit)\n  event.log.field = \"value\" -- set value of a field\n  event.log.another_field = nil -- remove field\n  event.log.first, event.log.second = nil, event.log.first -- rename field\n  emit(event) -- emit the processed event\nend"]}
  groups={["v2"]}
  name={"process"}
  path={"hooks"}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  >

#### process

A function which is called for each incoming event. It can produce new events
using `emit` function.




</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={["function (emit)\n  emit {\n    log = {\n      message = \"shutting down...\"\n    }\n  }\nend"]}
  groups={["v2"]}
  name={"shutdown"}
  path={"hooks"}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"string"}
  unit={null}
  >

#### shutdown

A function which is called when Vector is stopped. It can produce new events
using `emit` function.




</Field>
</Fields>

</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={[["/etc/vector/lua"]]}
  groups={["v1","v2"]}
  name={"search_dirs"}
  path={null}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"[string]"}
  unit={null}
  >

### search_dirs

A list of directories search when loading a Lua file via the `require` function.

 See [Search Directories](#search-directories) for more info.


</Field>
<Field
  common={true}
  defaultValue={null}
  enumValues={null}
  examples={["require(\"script\") # a `script.lua` file must be in your [`search_dirs`](#search_dirs)\n\nif event[\"host\"] == nil then\n  local f = io.popen (\"/bin/hostname\")\n  local hostname = f:read(\"*a\") or \"\"\n  f:close()\n  hostname = string.gsub(hostname, \"\\n$\", \"\")\n  event[\"host\"] = hostname\nend"]}
  groups={["v1"]}
  name={"source"}
  path={null}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  >

### source

In version 2 it is the source which is evaluated when the transform is created.
In version 1 it is the inline Lua source called for each incoming event.




</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={[]}
  groups={["v2"]}
  name={"timers"}
  path={null}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"[table]"}
  unit={null}
  >

### timers

Configures timers which are executed periodically at given interval



<Fields filters={false}>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={["function (emit)\n  emit {\n    log = {\n      message = \"current time: \" .. os.date()\n    }\n  }\nend\n"]}
  groups={["v2"]}
  name={"handler"}
  path={"timers"}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  >

#### handler

Defines a handler function which is executed periodially at [`interval_seconds`](#interval_seconds).
It can produce new events using`emit` function.




</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={[1,10,30]}
  groups={["v2"]}
  name={"interval_seconds"}
  path={"timers"}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"integer"}
  unit={null}
  >

#### interval_seconds

Defines the interval at which the timer handler would be executed.




</Field>
</Fields>

</Field>
<Field
  common={true}
  defaultValue={null}
  enumValues={{"2":"Lua transform API version 2"}}
  examples={["2"]}
  groups={["v2"]}
  name={"version"}
  path={null}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  >

### version

Transform API version




</Field>
</Fields>

## Output

<Tabs
  block={true}
  defaultValue="timings"
  values={[
    { label: 'Add Fields', value: 'add_fields', },
    { label: 'Remove Fields', value: 'remove_fields', },
    { label: 'Drop Event', value: 'drop_event', },
  ]
}>

<TabItem value="add_fields">

Add a field to an event. Supply this as the `hooks.proces` value:

```lua
function (event, emit)
  # Add root level field
  event.log.new_field = "new value"
  # Add nested field
  event.log.nested.field = "nested value"

  emit(event)
end
```

</TabItem>
<TabItem value="remove_fields">

Remove a field from an event. Supply this as the `hooks.process` value:

```lua
function (event, emit)
  # Remove root level field
  event.log.field = nil
  # Remove nested field
  event.log.nested.field = nil

  emit(event)
end
```

</TabItem>
<TabItem value="drop_event">

Drop an event entirely. Supply this as the `hooks.process` value:

```lua
function (event, emit)
  # Drop event entirely by not calling the emitting function
end
```

</TabItem>
</Tabs>

## How It Works

### Environment Variables

Environment variables are supported through all of Vector's configuration.
Simply add `${MY_ENV_VAR}` in your Vector configuration file and the variable
will be replaced before being evaluated.

You can learn more in the
[Environment Variables][docs.configuration#environment-variables] section.

### Dropping Events

To drop events, simply not call the emitting function with it. For example:

```lua
function (event, emit)
  if not event["message"].match(str, "debug") then
    emit(event)
  end
end
```

### Types

Event fields can be set to scalar values (booleans, numbers, or strings),
and the resulting event will keep the correct types. If an event field is
set to an invalid value, a message will be logged and the field will be dropped.

### Nested Fields

As described in the [Data Model document][docs.data_model], Vector flatten
events, representing nested field with a `.` delimiter. Therefore, adding,
accessing, or removing nested fields is as simple as added a `.` in your key
name:

```lua
# Add nested field
event.log.nested.field = "nested value"

# Remove nested field
event.log.nested.field = nil
```

### Iterate over fields

To iterate over all fields of an `event` use the [`pairs`][urls.lua_pairs] method.  For example:

```lua
function (event, emit)
  # Remove all fields where the value is "-"
  for f, v in pairs(event) do
    if v == "-" then
      event[f] = nil
    end
  end

  emit(event)
end
```

### Search Directories

Vector provides a [`search_dirs`](#search_dirs) option that allows you to specify absolute
paths that will searched when using the [Lua `require`
function][urls.lua_require].

### Lua Version

Vector uses the [`rlua` Rust crate][urls.rlua] which currently embeds Lua 5.3.

### Learning Lua

In order to write non-trivial transforms in Lua, one has to have basic
understanding of Lua. Because Lua is an easy to learn language, reading a few
first chapters of [the official book][urls.lua_pil] or consulting
[the manual][urls.lua_manual] would suffice.


[docs.configuration#environment-variables]: /docs/setup/configuration/#environment-variables
[docs.data-model.log]: /docs/about/data-model/log/
[docs.data-model.metric]: /docs/about/data-model/metric/
[docs.data_model]: /docs/about/data-model/
[urls.lua]: https://www.lua.org/
[urls.lua_manual]: https://www.lua.org/manual/5.3/manual.html
[urls.lua_pairs]: https://www.lua.org/manual/5.3/manual.html#pdf-pairs
[urls.lua_pil]: https://www.lua.org/pil/
[urls.lua_require]: https://www.lua.org/manual/5.3/manual.html#pdf-require
[urls.rlua]: https://github.com/kyren/rlua
